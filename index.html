<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>走马灯</title>
  <style>
    html,body {
      height: 100%;
      margin: 0;
      background: #000;
      color: #fff;
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
      touch-action: manipulation;
      overflow: hidden;
      font-family: "Helvetica Neue", Arial, sans-serif;
    }

    #viewport {
      /* 关键：改为 fixed，并用 left/top + translate 居中 */
      position: fixed;
      left: 50%;
      top: 50%;
      transform-origin: center center;
      /* 初始先居中但不旋转（JS 会设置具体 transform） */
      transform: translate(-50%, -50%) rotate(0deg);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      /* 可选：确保不被其它元素影响 */
      z-index: 1;
    }

    #display {
      position: relative;
      width: 100%;
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow: hidden;
    }

    #text {
      white-space: nowrap;
      display: inline-block;
      line-height: 1;
      will-change: transform;
      color: #fff;
      background: transparent;
      text-align: center;
      padding: 0 10px;
      box-sizing: content-box;
    }

    #overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      z-index: 20;
    }

    #panel {
      background: #111;
      color: #fff;
      padding: 12px;
      border-radius: 8px;
      width: 90%;
      max-width: 420px;
      box-sizing: border-box;
    }

    #panel label {
      font-size: 14px;
      display:block;
      margin-bottom:6px;
    }

    #inputText {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      font-size: 18px;
      border: 1px solid #333;
      border-radius: 4px;
      background: #000;
      color: #fff;
    }

    #buttons {
      margin-top: 8px;
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }

    .btn {
      padding: 8px 12px;
      border-radius: 4px;
      background: #222;
      color: #fff;
      border: 1px solid #333;
      font-size: 16px;
    }
    .btn.primary {
      background: #0b84ff;
      border-color: #0b84ff;
    }

    #hint {
      position: absolute;
      left: 8px;
      top: 8px;
      color: rgba(255,255,255,0.7);
      font-size: 12px;
      z-index: 10;
      background: rgba(0,0,0,0.2);
      padding: 6px 8px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div id="viewport">
    <div id="display">
      <div id="text">hello</div>
    </div>

    <div id="overlay" aria-hidden="true">
      <div id="panel" role="dialog" aria-modal="true">
        <label for="inputText">请输入（最多 40 个字符，支持中英及标点，不允许换行）：</label>
        <input id="inputText" type="text" maxlength="40" />
        <div id="msg" style="color:#f66;font-size:13px;margin-top:6px;height:18px;"></div>
        <div id="buttons">
          <button id="btnCancel" class="btn">取消</button>
          <button id="btnConfirm" class="btn primary">确认</button>
        </div>
      </div>
    </div>

    <div id="hint">点击屏幕可编辑/暂停</div>
  </div>

  <script>
    (function() {
      const viewport = document.getElementById('viewport');
      const display = document.getElementById('display');
      const textEl = document.getElementById('text');
      const overlay = document.getElementById('overlay');
      const input = document.getElementById('inputText');
      const btnConfirm = document.getElementById('btnConfirm');
      const btnCancel = document.getElementById('btnCancel');
      const msg = document.getElementById('msg');

      let anim = null;
      let isPlaying = true;
      let currentText = 'hello';

      function setTextAndAnimate(str) {
        stopAnimation();
        isPlaying = true; // 提前置为播放状态，确保新动画正常启动
        currentText = str;

        // 获取旋转后的实际可视宽高
        const rect = viewport.getBoundingClientRect();
        const visualWidth = rect.width;
        const visualHeight = rect.height;
        const isPortrait = visualHeight > visualWidth;
        const fontSize = isPortrait
          ? Math.floor(visualWidth * 0.85)
          : Math.floor(visualHeight * 0.85);

        // 清空 display，准备逐字符渲染
        display.innerHTML = '';
        const chars = str.split('');

        chars.forEach((ch, i) => {
          const el = document.createElement('div');
          el.textContent = ch;
          Object.assign(el.style, {
            position: 'absolute',
            fontSize: fontSize + 'px',
            lineHeight: '1',
            color: '#fff',
            background: 'transparent',
            textAlign: 'center',
            padding: '0',
            boxSizing: 'content-box',
            willChange: 'transform'
          });

          if (isPortrait) {
            // 竖屏：字符水平居中，垂直方向从底部向上错位
            el.style.left = '50%';
            el.style.transform = 'translateX(-50%)';
            const offset = fontSize * i;
            el.style.top = `${visualHeight + offset}px`;
          } else {
            // 横屏：字符垂直居中，水平方向从右侧向左错位
            el.style.top = '50%';
            el.style.transform = 'translateY(-50%)';
            const offset = fontSize * i;
            el.style.left = `${visualWidth + offset}px`;
          }

          display.appendChild(el);

          // 计算动画距离与时长
          const distance = isPortrait
            ? visualHeight + fontSize * (chars.length)
            : visualWidth + fontSize * (chars.length);
          const duration = isPortrait
            ? Math.min(25000, Math.max(3000, Math.round(distance * 5)))
            : Math.min(30000, Math.max(4000, Math.round(distance * 7)));

          // 动画：竖屏向上，横屏向左
          const keyframes = isPortrait
            ? [
                { transform: `translateX(-50%) translateY(0)` },
                { transform: `translateX(-50%) translateY(-${distance}px)` }
              ]
            : [
                { transform: `translateY(-50%) translateX(0)` },
                { transform: `translateY(-50%) translateX(-${distance}px)` }
              ];

          const anim = el.animate(keyframes, {
            duration,
            easing: 'linear',
            fill: 'forwards'
          });
          try {
            anim.play(); // 直接播放，无需判断
          } catch (e) {}

          // 为最后一个字符添加动画结束事件监听，实现循环播放
          if (i === chars.length - 1) {
            anim.onfinish = () => {
              setTextAndAnimate(str);
            };
          }

          // 暂停/恢复支持
          if (!isPlaying) {
            anim.pause();
          }
        });
      }


      function stopAnimation() {
        // 遍历所有字符元素，取消动画
        const charEls = display.querySelectorAll('div');
        charEls.forEach(el => {
          const anim = el.getAnimations()[0];
          if (anim) {
            try { anim.cancel(); } catch (e) {}
          }
        });
        //isPlaying = false;
      }

      function pauseAnimation() {
        const charEls = display.querySelectorAll('div');
        charEls.forEach(el => {
          const anim = el.getAnimations()[0];
          if (anim && isPlaying) {
            try { anim.pause(); } catch (e) {}
          }
        });
        isPlaying = false;
      }

      function resumeAnimation() {
        const charEls = display.querySelectorAll('div');
        charEls.forEach(el => {
          const anim = el.getAnimations()[0];
          if (anim && !isPlaying) {
            try { anim.play(); } catch (e) {}
          }
        });
        isPlaying = true;
      }

      function onBodyTap(e) {
        if (overlay.style.display === 'flex') return;
        pauseAnimation();
        openOverlay();
      }

      function openOverlay() {
        input.value = currentText;
        msg.textContent = '';
        overlay.style.display = 'flex';
        overlay.setAttribute('aria-hidden','false');
        input.focus();
        setTimeout(()=> input.setSelectionRange(input.value.length, input.value.length), 300);
      }
      function closeOverlay() {
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden','true');
      }

      // 验证：允许混合中英与常见标点，禁止换行，最多 40 个字符（按字符计数）
      function validateInput(s) {
        s = s.replace(/^\s+|\s+$/g, '');
        if (s.length === 0) return { ok:false, reason: '内容不能为空' };
        if (/[\r\n]/.test(s)) return { ok:false, reason: '不允许换行' };
        if (s.length > 40) return { ok:false, reason: '最多 40 个字符' };
        // 允许所有可见字符（包括中文、英文、标点）。若需进一步限制可在此扩展。
        return { ok:true, normalized: s };
      }

      btnConfirm.addEventListener('click', () => {
        const val = input.value || '';
        const v = validateInput(val);
        if (!v.ok) {
          msg.textContent = v.reason;
          return;
        }
        msg.textContent = '';
        closeOverlay();
        setTextAndAnimate(v.normalized);
      });

      btnCancel.addEventListener('click', () => {
        msg.textContent = '';
        closeOverlay();
        resumeAnimation();
      });

      overlay.addEventListener('click', (ev) => {
        if (ev.target === overlay) {
          msg.textContent = '';
          closeOverlay();
          resumeAnimation();
        }
      });

      document.addEventListener('pointerdown', function(e) {
        if (overlay.style.display === 'flex') return;
        e.preventDefault();
        onBodyTap(e);
      }, {passive: false});

      // 方向处理
      function applyRotation(angle) {
        // 不旋转 viewport，或仅保持 translate(-50%,-50%)
        viewport.style.transform = 'translate(-50%,-50%)';
        viewport.style.webkitTransform = 'translate(-50%,-50%)';
        // 把 translate(-50%,-50%) 保留在 transform 中，确保旋转后容器仍然居中
        //const t = `translate(-50%,-50%) rotate(${angle}deg)`;
        //viewport.style.transform = t;
        //viewport.style.webkitTransform = t;
        //viewport.style.transform = `rotate(${angle}deg)`;
        //viewport.style.webkitTransform = `rotate(${angle}deg)`;
      }

      function handleOrientationChange() {
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        viewport.style.width = vw + 'px';
        viewport.style.height = vh + 'px';
        // 不旋转 viewport
        applyRotation(0);
        // 等一帧再重建动画，确保尺寸生效
        requestAnimationFrame(() => setTextAndAnimate(currentText));
        //let angle = 0;
        // iOS Safari 优先使用 window.orientation
        /* if (typeof window.orientation === 'number') {
          angle = window.orientation;
        } else if (screen.orientation && typeof screen.orientation.angle === 'number') {
          angle = screen.orientation.angle;
        }
        angle = ((angle % 360) + 360) % 360; */
        // 先设置宽高，再 applyRotation（因为后续动画按 getBoundingClientRect 读取）
        /* const vw = window.innerWidth;
        const vh = window.innerHeight; */
        
        
        // 动态调整viewport宽高以适应横屏
        //const vw = document.documentElement.clientWidth;
        //const vh = document.documentElement.clientHeight;
      /*   if (angle === 90 || angle === 270) {
           // 横屏时交换宽高（容器内部坐标系保持竖直）
          viewport.style.width = vh + 'px';
          viewport.style.height = vw + 'px';
        } else {
          viewport.style.width = vw + 'px';
          viewport.style.height = vh + 'px';
        }
        applyRotation(angle);
        // 重启动画以适应新的方向
        setTextAndAnimate(currentText); */
      }

      function handleDeviceOrientationFallback(e) {
        if (typeof screen.orientation !== 'undefined' || typeof window.orientation === 'number') return;
        const gamma = e.gamma;
        if (gamma == null) return;
        if (gamma > 20) {
          applyRotation(90);
        } else if (gamma < -20) {
          applyRotation(270);
        } else {
          applyRotation(0);
        }
      }

      function init() {
        // 先检测方向，再渲染文字，确保首次渲染方向正确
        if ('onorientationchange' in window) {
          window.addEventListener('orientationchange', handleOrientationChange);
        }
        if (screen.orientation && screen.orientation.addEventListener) {
          try { screen.orientation.addEventListener('change', handleOrientationChange); } catch(e) {}
        }
        handleOrientationChange();

        window.addEventListener('deviceorientation', handleDeviceOrientationFallback, true);

        document.addEventListener('contextmenu', e => e.preventDefault());
        window.addEventListener('resize', () => {
          setTextAndAnimate(currentText);
          if (!isPlaying) {
            pauseAnimation();
          }
        });
      }

      init();

    })();
  </script>
</body>
</html>
